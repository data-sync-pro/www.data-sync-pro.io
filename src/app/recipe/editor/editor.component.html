<div class="recipe-editor-container">
  <!-- Header Bar -->
  <div class="editor-header">
    <div class="editor-brand">
      <a routerLink="/" class="brand-link" title="Return to Data Sync Pro">
        <img src="assets/logo.png" alt="Data Sync Pro" class="brand-logo">
        <span class="brand-text">DSP</span>
      </a>
      <h1 class="editor-title">Recipe Editor</h1>
    </div>
    
    <div class="editor-stats">
      <span class="stat-item">
        <strong>{{ recipeList.length }}</strong> Total Recipes
      </span>
      <span class="stat-item created tooltip-container" 
            *ngIf="getCreatedCount() > 0"
            (mouseenter)="onTooltipEnter('created')" 
            (mouseleave)="onTooltipLeave()">
        <strong>{{ getCreatedCount() }}</strong> Created
        <div class="tooltip-content" *ngIf="showTooltip === 'created'"
             (mouseenter)="onTooltipEnter('created')"
             (mouseleave)="onTooltipLeave()">
          <div class="tooltip-header">Created Recipes:</div>
          <div class="tooltip-item clickable" 
               *ngFor="let item of getCreatedRecipeTitles()"
               (click)="onTooltipRecipeClick(item.recipeId); $event.stopPropagation()"
               title="Click to edit this recipe">
            {{ item.title }}
          </div>
          <div class="tooltip-more" *ngIf="getCreatedCount() > 10">
            ...and {{ getCreatedCount() - 10 }} more
          </div>
        </div>
      </span>
      <span class="stat-item edited tooltip-container" 
            *ngIf="getEditedExistingCount() > 0"
            (mouseenter)="onTooltipEnter('edited')" 
            (mouseleave)="onTooltipLeave()">
        <strong>{{ getEditedExistingCount() }}</strong> Edited
        <div class="tooltip-content" *ngIf="showTooltip === 'edited'"
             (mouseenter)="onTooltipEnter('edited')"
             (mouseleave)="onTooltipLeave()">
          <div class="tooltip-header">Edited Recipes:</div>
          <div class="tooltip-item clickable" 
               *ngFor="let item of getEditedExistingRecipeTitles()"
               (click)="onTooltipRecipeClick(item.recipeId); $event.stopPropagation()"
               title="Click to edit this recipe">
            {{ item.title }}
          </div>
          <div class="tooltip-more" *ngIf="getEditedExistingCount() > 10">
            ...and {{ getEditedExistingCount() - 10 }} more
          </div>
        </div>
      </span>
      <span class="stat-item" *ngIf="state.lastSaved">
        Last saved: {{ state.lastSaved | date:'short' }}
      </span>
    </div>

    <div class="editor-actions">
      <button class="btn btn-secondary" 
              (click)="triggerImport()"
              [disabled]="state.isImporting">
        <span *ngIf="!state.isImporting">Import Recipe</span>
        <span *ngIf="state.isImporting">Importing...</span>
      </button>
      <button class="btn btn-primary" (click)="exportEditedAndNewRecipes()"
              [disabled]="editedRecipeIds.size === 0 || state.isImporting">
        Export Edit & New ({{ editedRecipeIds.size }})
      </button>
      <button class="btn btn-primary" (click)="exportAllRecipes()"
              [disabled]="recipeList.length === 0 || state.isImporting">
        Export All ({{ recipeList.length }})
      </button>
      <button class="btn btn-success" (click)="saveAllTabs()"
              [disabled]="!hasUnsavedChanges() || state.isImporting">
        Save All
      </button>
      <button class="btn btn-danger" 
              (click)="clearAllData()"
              [disabled]="state.isImporting">
        Clear All Data
      </button>
    </div>
  </div>

  <!-- Import/Export Progress Bar -->
  <div class="import-progress-overlay"
       *ngIf="state.isImporting"
       [ngClass]="{'show': state.isImporting}">
    <div class="import-progress-dialog">
      <h3>{{ state.importProgress?.step?.includes('xport') ? 'Exporting Recipes' : 'Processing Recipes' }}</h3>
      <div class="progress-bar-container" *ngIf="state.importProgress">
        <div class="progress-bar">
          <div class="progress-fill"
               [style.width.%]="Math.round((state.importProgress.current / state.importProgress.total) * 100)"></div>
        </div>
        <div class="progress-text">
          {{ state.importProgress.step }} ({{ state.importProgress.current }}/{{ state.importProgress.total }})
        </div>
        <div class="progress-percentage">{{ Math.round((state.importProgress.current / state.importProgress.total) * 100) }}%</div>
      </div>
      <div class="loading-spinner" *ngIf="!state.importProgress">
        <div class="spinner"></div>
        <div>Processing...</div>
      </div>
    </div>
  </div>

  <!-- Tabs Container -->
  <div class="tabs-container" *ngIf="state.tabs.length > 0">
    <div class="tabs">
      <div class="tab" 
           *ngFor="let tab of state.tabs; trackBy: trackByIndex"
           [class.active]="tab.isActive"
           [class.has-changes]="tab.hasChanges"
           (click)="selectTab(tab.id)">
        <span class="tab-title">{{ tab.title }}</span>
        <span class="changes-indicator" *ngIf="tab.hasChanges">‚óè</span>
        <button class="close-tab" 
                *ngIf="state.tabs.length > 1"
                (click)="closeTab(tab.id); $event.stopPropagation()">√ó</button>
      </div>
      <button class="add-tab" (click)="createNewTab()">+ Add Recipe</button>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="editor-main">
    <!-- Left Sidebar - Recipe List -->
    <div class="recipe-list-panel">
      <!-- Search and Filter -->
      <div class="list-controls">
        <input type="text" 
               class="dsp-input dsp-input--search"
               placeholder="Search recipes..."
               [(ngModel)]="searchQuery"
               (input)="filterRecipes()">
        
        <select class="category-filter"
                [(ngModel)]="selectedCategory"
                (change)="filterRecipes()">
          <option value="">All Categories</option>
          <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
        </select>
      </div>

      <!-- Recipe List -->
      <div class="recipe-list">
        <div class="recipe-item"
             *ngFor="let recipe of filteredRecipes"
             [class.edited]="isRecipeEdited(recipe.id)"
             [class.inactive]="!isRecipeActive(recipe.id)"
             (click)="loadRecipeToEditor(recipe)">
          <div class="recipe-item-header">
            <span class="status-indicator inactive" *ngIf="!isRecipeActive(recipe.id)" title="Inactive Recipe">üö´</span>
            <span class="edit-indicator" *ngIf="isRecipeEdited(recipe.id)">‚úèÔ∏è</span>
          </div>
          <div class="recipe-title">{{ recipe.title }}</div>
          <div class="recipe-category">{{ recipe.category }}</div>
        </div>
      </div>
    </div>

    <!-- Middle - Editor -->
    <div class="editor-panel" *ngIf="currentRecipe">
      <!-- Loading indicator -->
      <div class="loading-indicator" *ngIf="state.isLoading">
        <p>Loading recipe...</p>
      </div>

      <div class="recipe-form" *ngIf="!state.isLoading">
        <!-- Basic Information -->
        <app-basic-info
          *ngIf="currentRecipe"
          [recipe]="currentRecipe"
          [isActive]="currentIsActive"
          [categories]="categories"
          (recipeChange)="onRecipeChange()"
          (activeChange)="onActiveStatusChange($event)">
        </app-basic-info>

        <!-- Downloadable Executables -->
        <app-file-upload
          *ngIf="currentRecipe"
          [downloadableExecutables]="currentRecipe.downloadableExecutables"
          (downloadableExecutablesChange)="onRecipeChange()">
        </app-file-upload>

        <!-- General Images -->
        <app-image-manager
          *ngIf="currentRecipe"
          [generalImages]="currentRecipe.generalImages"
          [stepIndex]="-1"
          [recipeId]="currentRecipe.id || ''"
          [recipeCategory]="currentRecipeFirstCategory"
          (generalImagesChange)="onRecipeChange()">
        </app-image-manager>

        <!-- Prerequisites -->
        <app-prerequisites-editor
          *ngIf="currentRecipe"
          [prerequisites]="currentRecipe.prerequisites"
          (prerequisitesChange)="onRecipeChange()">
        </app-prerequisites-editor>

        <!-- Walkthrough -->
        <app-walkthrough-editor
          *ngIf="currentRecipe"
          [walkthrough]="currentRecipe.walkthrough"
          [stepOptions]="stepOptions"
          [expandedSteps]="expandedSteps"
          [customStepNames]="customStepNames"
          [recipeId]="currentRecipe.id || ''"
          [recipeCategory]="currentRecipeFirstCategory"
          (walkthroughChange)="onRecipeChange()"
          (stepExpansionToggle)="toggleStep($event)">
        </app-walkthrough-editor>
      </div>
    </div>

    <!-- Right - Preview Panel -->
    <app-preview-panel
      *ngIf="currentRecipe"
      [jsonPreview]="jsonPreview"
      (copyToClipboard)="copyToClipboard($event)"
      (openPreviewInNewTab)="openPreviewInNewTab()">
    </app-preview-panel>
  </div>

  <!-- No Selection Message -->
  <div class="no-selection" *ngIf="!currentRecipe && !state.isLoading">
    <p>Create a new recipe or select one from the list to start editing</p>
    <button class="btn btn-primary" (click)="createNewTab()">Create New Recipe</button>
  </div>

  <!-- Hidden file input for import -->
  <input type="file" 
         #fileInput
         accept=".json,.zip"
         style="display: none"
         (change)="importRecipe($event)">

</div>