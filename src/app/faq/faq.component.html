<!-- Mobile sidebar toggle button -->
<button
  class="mobile-sidebar-toggle"
  (click)="toggleMobileSidebar()"
  *ngIf="ui.isMobile"
>
  â˜°
</button>

<!-- Mobile TOC toggle button -->
<button
  class="mobile-toc-toggle"
  (click)="toggleMobileTOC()"
  *ngIf="ui.isMobile && shouldShowTOC"
>
  ğŸ“‹
</button>

<!-- Mobile sidebar overlay -->
<div
  class="sidebar-overlay"
  [class.active]="ui.mobileSidebarOpen"
  (click)="closeMobileSidebar()"
></div>

<!-- W3Schoolsé£æ ¼çš„ç½‘æ ¼å¸ƒå±€å®¹å™¨ -->
<div class="faq-layout-container">
  <!-- Left Sidebar - Gridå®šä½ -->
  <aside
    class="faq-sidebar"
    [class.mobile-open]="ui.mobileSidebarOpen"
    [class.collapsed]="ui.sidebarCollapsed"
  >
      <div class="sidebar-content">
        <!-- Sidebar Header -->
        <div class="sidebar-header">
          <div class="sidebar-title-section" *ngIf="!ui.sidebarCollapsed">
            <h2 class="sidebar-main-title">FAQ</h2>
            <span class="sidebar-subtitle">{{ faqList.length }} articles</span>
          </div>
          <button
            class="sidebar-toggle-btn"
            (click)="toggleSidebar()"
            title="Toggle sidebar"
          >
            <lightning-icon
              [iconName]="ui.sidebarCollapsed ? 'utility:chevronright' : 'utility:chevronleft'"
              size="xx-small"
              [alternativeText]="ui.sidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar'"
            ></lightning-icon>
          </button>
        </div>

        <div class="sidebar-body">
          <!-- Search in sidebar -->
          <div class="sidebar-search" *ngIf="!ui.sidebarCollapsed">
            <button
              class="sidebar-search-btn"
              (click)="openSearchOverlay()"
              title="Search FAQs"
            >
              <lightning-icon
                iconName="utility:search"
                size="xx-small"
                alternativeText="Search"
              ></lightning-icon>
              <span class="search-text">Search...</span>
            </button>
          </div>

          <!-- Navigation Tree -->
          <div class="sidebar-nav">
            <!-- Home -->
            <div class="nav-item home-nav" [class.active]="showHome" (click)="goHome()">
              <div class="nav-content">
                <lightning-icon
                  iconName="utility:home"
                  size="x-small"
                  alternativeText="Home"
                  class="nav-icon"
                ></lightning-icon>
                <span class="nav-text" *ngIf="!ui.sidebarCollapsed">All FAQs</span>
                <span class="nav-count" *ngIf="!ui.sidebarCollapsed">{{ faqList.length }}</span>
              </div>
            </div>

            <!-- Categories -->
            <div class="nav-section" *ngIf="!ui.sidebarCollapsed">
              <div class="section-divider"></div>
              <div class="section-label">Categories</div>
            </div>

            <div class="nav-tree">
              <div
                *ngFor="let category of categories"
                class="nav-category"
              >
                <!-- Category Item -->
                <div
                  class="nav-item category-nav"
                  [class.active]="current.category === category.name && !current.subCategory"
                  [class.expanded]="current.category === category.name"
                  (click)="selectCategory(category.name)"
                >
                  <div class="nav-content">
                    <lightning-icon
                      iconName="utility:folder"
                      size="xx-small"
                      [alternativeText]="category.name + ' category'"
                      class="nav-icon"
                    ></lightning-icon>
                    <span class="nav-text" *ngIf="!ui.sidebarCollapsed">{{ category.name }}</span>
                    <span class="nav-count" *ngIf="!ui.sidebarCollapsed">{{ category.count }}</span>
                  </div>
                </div>

                <!-- Subcategories -->
                <div
                  class="subcategory-container"
                  *ngIf="current.category === category.name && category.subCategories.length > 0 && !ui.sidebarCollapsed"
                >
                  <div
                    *ngFor="let subCategory of category.subCategories"
                    class="nav-item subcategory-nav"
                    [class.active]="current.subCategory === subCategory.name"
                    (click)="selectSubCategory(subCategory.name)"
                  >
                    <div class="nav-content">
                      <span class="nav-indent"></span>
                      <lightning-icon
                        iconName="utility:tag"
                        size="xx-small"
                        [alternativeText]="subCategory.name + ' subcategory'"
                        class="nav-icon"
                      ></lightning-icon>
                      <span class="nav-text">{{ subCategory.name }}</span>
                      <span class="nav-count">{{ subCategory.count }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </aside>

  <!-- Main content area with proper container -->
  <div class="faq-container" [class.toc-hidden]="ui.tocHidden">
  <!-- Breadcrumb Navigation -->
  <nav class="breadcrumb-nav" *ngIf="current.category || current.subCategory">
    <div class="breadcrumb">
      <button class="breadcrumb-item" (click)="goHome()" title="Go to Home">
        <lightning-icon iconName="utility:home" size="xx-small" alternativeText="Home"></lightning-icon>
        <span>All FAQs</span>
      </button>
      
      <span class="breadcrumb-separator" *ngIf="current.category">
        <lightning-icon iconName="utility:chevronright" size="xx-small" alternativeText="Next"></lightning-icon>
      </span>
      
      <button 
        *ngIf="current.category"
        class="breadcrumb-item"
        [class.active]="!current.subCategory"
        (click)="goCategory(current.category)"
        [title]="'Go to ' + current.category"
      >
        <span>{{ current.category }}</span>
      </button>
      
      <span class="breadcrumb-separator" *ngIf="current.subCategory">
        <lightning-icon iconName="utility:chevronright" size="xx-small" alternativeText="Next"></lightning-icon>
      </span>
      
      <span 
        *ngIf="current.subCategory"
        class="breadcrumb-item active"
      >
        <span>{{ current.subCategory }}</span>
      </span>
    </div>
  </nav>

  <main class="faq-main">
      <!-- é¦–é¡µï¼šæ˜¾ç¤ºæ‰€æœ‰FAQ -->
      <div *ngIf="showHome" class="all-faqs">
        <h2 class="section-title">All FAQs</h2>
        
        <!-- Loading skeleton for initial load -->
        <app-faq-skeleton 
          *ngIf="isLoadingState" 
          type="list" 
          [count]="8">
        </app-faq-skeleton>
        
        <!-- FAQ content -->
        <ng-container 
          *ngIf="!isLoadingState"
          [ngTemplateOutlet]="faqListTemplate" 
          [ngTemplateOutletContext]="{ faqItems: allFaqList }">
        </ng-container>
      </div>

      <!-- åˆ†ç±»é¡µé¢ï¼šæ˜¾ç¤ºåˆ†ç±»ä»‹ç» -->
      <div *ngIf="!showHome && !current.faqItem && !search.isActive" class="category-intro">
        <div class="category-header">
          <h2 class="category-title">
            {{ current.subCategory || current.category }}
          </h2>
        </div>
      </div>

      <!-- å•ä¸ªFAQè¯¦æƒ…æ˜¾ç¤º -->
      <div *ngIf="current.faqItem && !search.isActive && !search.query.trim()" class="faq-detail">
        <div class="faq-detail-content">
          <h2 class="faq-question">{{ current.faqItem.question }}</h2>
          
          <!-- Loading skeleton for FAQ content -->
          <app-faq-skeleton 
            *ngIf="current.faqItem.isLoading" 
            type="detail">
          </app-faq-skeleton>
          
          <!-- FAQ content -->
          <div 
            *ngIf="!current.faqItem.isLoading && current.faqItem.safeAnswer"
            class="faq-answer" 
            [innerHTML]="current.faqItem.safeAnswer" 
            appSimpleZoomable>
          </div>

          <!-- FAQ Feedback and Share Section -->
          <div class="faq-feedback-section">
            <div class="feedback-container">
              <!-- Helpful Rating -->
              <div class="helpful-rating">
                <div class="rating-header">
                  <h4 class="rating-title">Was this helpful?</h4>
                  <div class="rating-buttons">
                    <button
                      class="rating-btn rating-btn-yes"
                      (click)="rateFAQ(current.faqItem, true)"
                      [class.active]="current.faqItem.userRating === true"
                      [attr.aria-pressed]="current.faqItem.userRating === true"
                      title="Yes, this was helpful"
                    >
                      <span class="rating-icon">ğŸ‘</span>
                      <span class="rating-text">Yes</span>
                    </button>
                    <button
                      class="rating-btn rating-btn-no"
                      (click)="rateFAQ(current.faqItem, false)"
                      [class.active]="current.faqItem.userRating === false"
                      [attr.aria-pressed]="current.faqItem.userRating === false"
                      title="No, this was not helpful"
                    >
                      <span class="rating-icon">ğŸ‘</span>
                      <span class="rating-text">No</span>
                    </button>
                  </div>
                </div>
                
                <!-- Thank you message -->
                <div class="rating-feedback" *ngIf="current.faqItem.userRating !== null">
                  <div class="feedback-message" [class.positive]="current.faqItem.userRating" [class.negative]="!current.faqItem.userRating">
                    <span class="feedback-icon">{{ current.faqItem.userRating ? 'âœ…' : 'ğŸ’­' }}</span>
                    <span class="feedback-text">
                      {{ current.faqItem.userRating ? 'Thank you for your feedback!' : 'Thanks! We\'ll work on improving this.' }}
                    </span>
                  </div>
                </div>
              </div>

              <!-- Share Options -->
              <div class="share-options">
                <div class="share-header">
                  <h4 class="share-title">Share this FAQ</h4>
                  <div class="share-buttons">
                    <button
                      class="share-btn primary"
                      (click)="copyFAQLink(current.faqItem)"
                      title="Copy link to clipboard"
                    >
                      <span class="share-icon">ğŸ”—</span>
                      <span class="share-text">Copy Link</span>
                    </button>
                    
                    <div class="social-share-dropdown">
                      <button
                        class="share-btn secondary"
                        (click)="toggleSocialShare(current.faqItem)"
                        title="More sharing options"
                        [class.active]="current.faqItem.showSocialShare"
                      >
                        <span class="share-icon">ğŸ“¤</span>
                        <span class="share-text">Share</span>
                        <span class="dropdown-arrow" [class.rotated]="current.faqItem.showSocialShare">â–¼</span>
                      </button>
                      
                      <div class="social-menu" *ngIf="current.faqItem.showSocialShare" [@slideInOut]>
                        <button
                          class="social-btn twitter"
                          (click)="shareToSocial('twitter', current.faqItem)"
                          title="Share on Twitter"
                        >
                          <span class="social-icon">ğŸ¦</span>
                          <span class="social-label">Twitter</span>
                        </button>
                        <button
                          class="social-btn facebook"
                          (click)="shareToSocial('facebook', current.faqItem)"
                          title="Share on Facebook"
                        >
                          <span class="social-icon">ğŸ“˜</span>
                          <span class="social-label">Facebook</span>
                        </button>
                        <button
                          class="social-btn linkedin"
                          (click)="shareToSocial('linkedin', current.faqItem)"
                          title="Share on LinkedIn"
                        >
                          <span class="social-icon">ğŸ’¼</span>
                          <span class="social-label">LinkedIn</span>
                        </button>
                        <button
                          class="social-btn email"
                          (click)="shareToSocial('email', current.faqItem)"
                          title="Share via Email"
                        >
                          <span class="social-icon">âœ‰ï¸</span>
                          <span class="social-label">Email</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- æœç´¢ç»“æœå’Œåˆ†ç±»æµè§ˆçš„FAQåˆ—è¡¨ -->
      <ng-container *ngIf="!showHome && (!current.faqItem || search.isActive || search.query.trim())">
        <!-- Loading skeleton for search/category filtering -->
        <app-faq-skeleton 
          *ngIf="isLoadingState" 
          type="search" 
          [count]="6">
        </app-faq-skeleton>
        
        <!-- FAQ list content -->
        <ng-container 
          *ngIf="!isLoadingState"
          [ngTemplateOutlet]="faqListTemplate" 
          [ngTemplateOutletContext]="{ faqItems: filteredFAQ }">
        </ng-container>

        <!-- æœç´¢æ— ç»“æœæ—¶çš„ä¼˜åŒ–æ˜¾ç¤º -->
        <div class="no-results" *ngIf="filteredFAQ.length === 0">
          <div *ngIf="search.query.trim(); else noSearchResults" class="search-no-results">
            <div class="no-results-icon">
              <lightning-icon
                iconName="utility:search"
                size="medium"
                alternativeText="No search results"
              ></lightning-icon>
            </div>
            <h3>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ç»“æœ</h3>
            <p>æ²¡æœ‰æ‰¾åˆ°åŒ…å« "<strong>{{ search.query }}</strong>" çš„FAQã€‚</p>

            <div class="search-suggestions">
              <h4>å»ºè®®ï¼š</h4>
              <ul>
                <li>æ£€æŸ¥æ‹¼å†™æ˜¯å¦æ­£ç¡®</li>
                <li>å°è¯•ä½¿ç”¨æ›´ç®€å•çš„å…³é”®è¯</li>
                <li>ä½¿ç”¨åŒä¹‰è¯æˆ–ç›¸å…³è¯æ±‡</li>
                <li>å‡å°‘æœç´¢è¯çš„æ•°é‡</li>
              </ul>
            </div>

            <div class="popular-faqs">
              <h4>çƒ­é—¨FAQï¼š</h4>
              <div class="popular-faq-list">
                <button
                  class="popular-faq-item"
                  *ngFor="let faq of popularFAQs"
                  (click)="selectPopularFAQ(faq)"
                >
                  {{ faq.question }}
                </button>
              </div>
            </div>

            <div class="contact-support">
              <h4>ä»ç„¶éœ€è¦å¸®åŠ©ï¼Ÿ</h4>
              <p>å¦‚æœæ‚¨æ²¡æœ‰æ‰¾åˆ°æ‰€éœ€çš„ä¿¡æ¯ï¼Œè¯·è”ç³»æˆ‘ä»¬çš„æ”¯æŒå›¢é˜Ÿã€‚</p>
              <button class="contact-button" (click)="contactSupport()">
                è”ç³»æ”¯æŒ
              </button>
            </div>
          </div>

          <ng-template #noSearchResults>
            <div class="category-no-results">
              <p>æ­¤åˆ†ç±»ä¸‹æš‚æ— FAQã€‚</p>
            </div>
          </ng-template>
        </div>
      </ng-container>
  </main>
  </div>

  <!-- Desktop TOC - Gridå®šä½ -->
  <aside
    class="faq-toc desktop-toc"
    *ngIf="shouldShowTOC && !ui.isMobile"
    [class.collapsed]="isSidebarCollapsed"
    [class.hidden]="ui.tocHidden"
  >
    <div class="toc-content">
      <!-- Trending Questions for Home Page -->
      <div *ngIf="showHome" class="trending-toc">
        <div class="toc-header">
          <h3 class="toc-title">Trending Questions</h3>
          <span class="toc-count">{{ tocItemCount }} items</span>
        </div>

        <div class="toc-list">
          <div
            class="toc-item trending-item"
            *ngFor="let item of trendingQuestions; trackBy: trackByFAQ"
            [class.active]="isCurrentFAQ(item)"
            (click)="selectTrendingQuestion(item)"
          >
            <div class="toc-item-title">{{ item.question }}</div>
            <div class="toc-item-indicator" *ngIf="isCurrentFAQ(item)"></div>
          </div>
        </div>
      </div>

      <!-- Category TOC for Category Pages -->
      <div *ngIf="!showHome" class="category-toc">
        <div class="toc-header">
          <h3 class="toc-title">
            <span class="toc-category-name">{{ current.subCategory || current.category }}</span>
            <span class="toc-subtitle">FAQs</span>
          </h3>
          <span class="toc-count">{{ tocItemCount }} items</span>
        </div>

        <div class="toc-list">
          <div
            class="toc-item"
            *ngFor="let item of currentFAQList; trackBy: trackByFAQ"
            [class.active]="isCurrentFAQ(item)"
            (click)="scrollToFAQ(item)"
          >
            <div class="toc-item-title">{{ item.question }}</div>
            <div class="toc-item-indicator" *ngIf="isCurrentFAQ(item)"></div>
          </div>
        </div>
      </div>
    </div>
  </aside>
</div>

<!-- TOC Toggle Button -->
<button
  class="toc-toggle-btn"
  *ngIf="!ui.isMobile"
  (click)="toggleTOC()"
  [title]="ui.tocHidden ? 'Show Table of Contents' : 'Hide Table of Contents'"
>
  <lightning-icon
    [iconName]="ui.tocHidden ? 'utility:chevronleft' : 'utility:chevronright'"
    size="xx-small"
    [alternativeText]="ui.tocHidden ? 'Show TOC' : 'Hide TOC'"
  ></lightning-icon>
</button>

<!-- Removed duplicate TOC - now using grid-positioned version above -->

<!-- Mobile TOC Drawer -->
<div class="mobile-toc-overlay" 
     [class.active]="ui.mobileTOCOpen" 
     (click)="closeMobileTOC()"
     *ngIf="ui.isMobile"></div>

<aside
  class="faq-toc mobile-toc"
  *ngIf="shouldShowTOC && ui.isMobile"
  [class.open]="ui.mobileTOCOpen"
>
  <div class="mobile-toc-content">
    <!-- Mobile TOC Header -->
    <div class="mobile-toc-header">
      <h3 class="mobile-toc-title">
        {{ showHome ? 'Trending Questions' : currentTOCTitle }}
      </h3>
      <button 
        class="mobile-toc-close" 
        (click)="closeMobileTOC()"
        aria-label="Close Table of Contents">
        âœ•
      </button>
    </div>

    <!-- Mobile TOC List -->
    <div class="mobile-toc-list">
      <!-- Trending Questions for Home Page -->
      <ng-container *ngIf="showHome">
        <div
          class="mobile-toc-item trending-item"
          *ngFor="let item of trendingQuestions; trackBy: trackByFAQ"
          [class.active]="isCurrentFAQ(item)"
          (click)="selectTrendingQuestion(item); closeMobileTOC()"
        >
          <div class="mobile-toc-item-title">{{ item.question }}</div>
          <div class="mobile-toc-item-indicator" *ngIf="isCurrentFAQ(item)">ğŸ”¥</div>
        </div>
      </ng-container>

      <!-- Category TOC for Category Pages -->
      <ng-container *ngIf="!showHome">
        <div
          class="mobile-toc-item"
          *ngFor="let item of currentFAQList; trackBy: trackByFAQ"
          [class.active]="isCurrentFAQ(item)"
          (click)="scrollToFAQ(item); closeMobileTOC()"
        >
          <div class="mobile-toc-item-title">{{ item.question }}</div>
          <div class="mobile-toc-item-indicator" *ngIf="isCurrentFAQ(item)">ğŸ“</div>
        </div>
      </ng-container>
    </div>
  </div>
</aside>

<!-- å…±ç”¨FAQåˆ—è¡¨æ¨¡æ¿ -->
<ng-template #faqListTemplate let-faqItems="faqItems">
  <div class="faq-list">
    <!-- Virtual scrolling for large lists (more than 20 items) -->
    <cdk-virtual-scroll-viewport 
      *ngIf="faqItems.length > 20" 
      itemSize="120" 
      class="faq-virtual-viewport"
    >
      <div
        class="faq-item"
        *cdkVirtualFor="let item of faqItems; trackBy: trackByFAQ"
        (click)="navigateToFAQ(item)"
        [attr.aria-label]="'Navigate to FAQ: ' + item.question"
        role="button"
        tabindex="0"
        (keydown.enter)="navigateToFAQ(item)"
        (keydown.space)="$event.preventDefault(); navigateToFAQ(item)"
      >
        <div class="faq-header">
          <div class="faq-title-section">
            <div class="faq-question-row">
              <h3 class="faq-question" [id]="slugify(item.question)">{{ item.question }}</h3>
              <div class="category-badges">
                <span class="category-badge">{{ item.category }}</span>
                <span class="subcategory-badge" *ngIf="item.subCategory">{{ item.subCategory }}</span>
              </div>
            </div>
            <div class="faq-badges" *ngIf="item.viewCount">
              <span class="view-count">
                ğŸ‘ {{ item.viewCount || 0 }}
              </span>
            </div>
          </div>

          <div class="faq-actions">
            <lightning-icon
              iconName="utility:chevronright"
              size="xx-small"
              alternativeText="Navigate to FAQ"
              class="navigate-icon"
            ></lightning-icon>
          </div>
        </div>
      </div>
    </cdk-virtual-scroll-viewport>

    <!-- Regular scrolling for smaller lists -->
    <div *ngIf="faqItems.length <= 20" class="faq-regular-list">
      <div
        class="faq-item"
        *ngFor="let item of faqItems; trackBy: trackByFAQ"
        (click)="navigateToFAQ(item)"
        [attr.aria-label]="'Navigate to FAQ: ' + item.question"
        role="button"
        tabindex="0"
        (keydown.enter)="navigateToFAQ(item)"
        (keydown.space)="$event.preventDefault(); navigateToFAQ(item)"
      >
        <div class="faq-header">
          <div class="faq-title-section">
            <div class="faq-question-row">
              <h3 class="faq-question" [id]="slugify(item.question)">{{ item.question }}</h3>
              <div class="category-badges">
                <span class="category-badge">{{ item.category }}</span>
                <span class="subcategory-badge" *ngIf="item.subCategory">{{ item.subCategory }}</span>
              </div>
            </div>
            <div class="faq-badges" *ngIf="item.viewCount">
              <span class="view-count">
                ğŸ‘ {{ item.viewCount || 0 }}
              </span>
            </div>
          </div>

          <div class="faq-actions">
            <lightning-icon
              iconName="utility:chevronright"
              size="xx-small"
              alternativeText="Navigate to FAQ"
              class="navigate-icon"
            ></lightning-icon>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<!-- Search overlay -->
<app-search-overlay
  *ngIf="search.isOpen"
  [isOpen]="search.isOpen"
  (closed)="search.isOpen = false"
  (selectedResult)="handleSearchSelect($event)"
></app-search-overlay>
