<div class="recipe-editor-container">
  <!-- Header Bar -->
  <div class="editor-header">
    <div class="editor-brand">
      <a routerLink="/" class="brand-link" title="Return to Data Sync Pro">
        <img src="assets/logo.png" alt="Data Sync Pro" class="brand-logo">
        <span class="brand-text">DSP</span>
      </a>
      <h1 class="editor-title">Recipe Editor</h1>
    </div>
    
    <div class="editor-stats">
      <span class="stat-item">
        <strong>{{ recipeList.length }}</strong> Total Recipes
      </span>
      <span class="stat-item edited">
        <strong>{{ editedRecipeIds.size }}</strong> Edited
      </span>
      <span class="stat-item" *ngIf="state.lastSaved">
        Last saved: {{ state.lastSaved | date:'short' }}
      </span>
    </div>

    <div class="editor-actions">
      <button class="btn btn-secondary" (click)="triggerImport()">
        Import Recipe
      </button>
      <button class="btn btn-primary" (click)="exportCurrentRecipe()"
              [disabled]="!currentRecipe">
        Export Current
      </button>
      <button class="btn btn-primary" (click)="exportAllRecipes()"
              [disabled]="editedRecipeIds.size === 0">
        Export All ({{ editedRecipeIds.size }})
      </button>
      <button class="btn btn-success" (click)="saveAllTabs()"
              [disabled]="!hasUnsavedChanges()">
        Save All
      </button>
      <button class="btn btn-danger" (click)="clearAllData()">
        Clear All Data
      </button>
    </div>
  </div>

  <!-- Tabs Container -->
  <div class="tabs-container" *ngIf="state.tabs.length > 0">
    <div class="tabs">
      <div class="tab" 
           *ngFor="let tab of state.tabs; trackBy: trackByIndex"
           [class.active]="tab.isActive"
           [class.has-changes]="tab.hasChanges"
           (click)="selectTab(tab.id)">
        <span class="tab-title">{{ tab.title }}</span>
        <span class="changes-indicator" *ngIf="tab.hasChanges">●</span>
        <button class="close-tab" 
                *ngIf="state.tabs.length > 1"
                (click)="closeTab(tab.id); $event.stopPropagation()">×</button>
      </div>
      <button class="add-tab" (click)="createNewTab()">+ Add Recipe</button>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="editor-main">
    <!-- Left Sidebar - Recipe List -->
    <div class="recipe-list-panel">
      <!-- Search and Filter -->
      <div class="list-controls">
        <input type="text" 
               class="dsp-input dsp-input--search"
               placeholder="Search recipes..."
               [(ngModel)]="searchQuery"
               (input)="filterRecipes()">
        
        <select class="category-filter"
                [(ngModel)]="selectedCategory"
                (change)="filterRecipes()">
          <option value="">All Categories</option>
          <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
        </select>
      </div>

      <!-- Recipe List -->
      <div class="recipe-list">
        <div class="recipe-item"
             *ngFor="let recipe of filteredRecipes"
             [class.edited]="isRecipeEdited(recipe.id)"
             (click)="loadRecipeToEditor(recipe)">
          <div class="recipe-item-header">
            <span class="recipe-id">{{ recipe.id }}</span>
            <span class="edit-indicator" *ngIf="isRecipeEdited(recipe.id)">✏️</span>
          </div>
          <div class="recipe-title">{{ recipe.title }}</div>
          <div class="recipe-category">{{ recipe.category }}</div>
        </div>
      </div>
    </div>

    <!-- Middle - Editor -->
    <div class="editor-panel" *ngIf="currentRecipe">
      <!-- Loading indicator -->
      <div class="loading-indicator" *ngIf="state.isLoading">
        <p>Loading recipe...</p>
      </div>

      <div class="recipe-form" *ngIf="!state.isLoading">
        <!-- Basic Information -->
        <div class="form-section">
          <h2>Basic Information</h2>
          
          <div class="form-row">
            <div class="form-group">
              <label for="title">Title *</label>
              <input type="text" 
                     id="title"
                     class="dsp-input"
                     [(ngModel)]="currentRecipe.title"
                     (input)="onRecipeChange()"
                     required>
            </div>
            
            <div class="form-group">
              <label for="category">Category *</label>
              <select id="category"
                      class="dsp-input"
                      [(ngModel)]="currentRecipe.category"
                      (change)="onRecipeChange()"
                      required>
                <option value="">Select category</option>
                <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="overview">Overview *</label>
            <textarea id="overview"
                      class="dsp-input"
                      rows="3"
                      [(ngModel)]="currentRecipe.overview"
                      (input)="onRecipeChange()"
                      placeholder="Detailed overview of what this recipe does"
                      required></textarea>
          </div>

          <div class="form-group">
            <label for="whenToUse">When to Use</label>
            <textarea id="whenToUse"
                      class="dsp-input"
                      rows="3"
                      [(ngModel)]="currentRecipe.whenToUse"
                      (input)="onRecipeChange()"
                      placeholder="Describe when this recipe should be used"></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="direction">Direction</label>
              <input type="text"
                     id="direction"
                     class="dsp-input"
                     [(ngModel)]="currentRecipe.direction"
                     (input)="onRecipeChange()"
                     placeholder="e.g. Current ⇒ Current">
            </div>
            
            <div class="form-group">
              <label for="connection">Connection</label>
              <input type="text"
                     id="connection"
                     class="dsp-input"
                     [(ngModel)]="currentRecipe.connection"
                     (input)="onRecipeChange()">
            </div>
          </div>

          <!-- DSP Versions -->
          <div class="form-group">
            <label>DSP Versions</label>
            <div class="dynamic-list">
              <div class="dynamic-item" 
                   *ngFor="let version of currentRecipe.DSPVersions; let i = index; trackBy: trackByIndex">
                <input type="text"
                       class="dsp-input"
                       [(ngModel)]="currentRecipe.DSPVersions[i]"
                       (input)="onRecipeChange()"
                       placeholder="Version">
                <button type="button" 
                        class="btn btn-sm btn-danger"
                        (click)="removeDSPVersion(i)">−</button>
              </div>
              <button type="button" 
                      class="btn btn-sm btn-secondary"
                      (click)="addDSPVersion()">+ Add Version</button>
            </div>
          </div>

          <!-- Keywords -->
          <div class="form-group">
            <label>Keywords</label>
            <div class="dynamic-list">
              <div class="dynamic-item" 
                   *ngFor="let keyword of currentRecipe.keywords; let i = index; trackBy: trackByIndex">
                <input type="text"
                       class="dsp-input"
                       [(ngModel)]="currentRecipe.keywords[i]"
                       (input)="onRecipeChange()"
                       placeholder="Keyword">
                <button type="button" 
                        class="btn btn-sm btn-danger"
                        (click)="removeKeyword(i)">−</button>
              </div>
              <button type="button" 
                      class="btn btn-sm btn-secondary"
                      (click)="addKeyword()">+ Add Keyword</button>
            </div>
          </div>

          <!-- General Images -->
          <div class="form-group">
            <label>General Images</label>
            <div class="general-images-container">
              <div class="general-images-list">
                <div class="general-image-item" 
                     *ngFor="let image of currentRecipe.generalImages; let i = index; trackBy: trackByIndex">
                  <div class="image-preview" *ngIf="image.url">
                    <img [src]="image.url" 
                         [alt]="image.alt" 
                         class="preview-thumbnail clickable-image"
                         (click)="openImagePreview(image.url, image.alt)"
                         title="Click to enlarge">
                  </div>
                  <div class="image-details">
                    <select class="dsp-input"
                            [(ngModel)]="image.type"
                            (change)="onRecipeChange()">
                      <option value="image">Image</option>
                      <option value="video">Video</option>
                      <option value="gif">GIF</option>
                    </select>
                    <input type="text"
                           class="dsp-input"
                           [(ngModel)]="image.alt"
                           (input)="onRecipeChange()"
                           placeholder="Alt text or description">
                  </div>
                  <button type="button" 
                          class="btn btn-sm btn-danger"
                          (click)="removeGeneralImage(i)">×</button>
                </div>
              </div>
              
              <div class="general-image-upload-area"
                   (dragover)="$event.preventDefault()"
                   (drop)="onGeneralImageDrop($event)">
                <p>Drag and drop images here, or</p>
                <button type="button" 
                        class="btn btn-secondary"
                        (click)="addGeneralImage()">+ Add General Image</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Prerequisites -->
        <div class="form-section">
          <h2>Prerequisites</h2>
          
          <div class="prerequisite-item" 
               *ngFor="let prereq of currentRecipe.prerequisites; let i = index; trackBy: trackByIndex">
            <div class="form-group">
              <label>Description</label>
              <input type="text"
                     class="dsp-input"
                     [(ngModel)]="prereq.description"
                     (input)="onRecipeChange()"
                     placeholder="Prerequisite description">
            </div>

            <!-- Quick Links -->
            <div class="quick-links">
              <label>Quick Links</label>
              <div class="quick-link" 
                   *ngFor="let link of prereq.quickLinks; let j = index; trackBy: trackByIndex">
                <input type="text"
                       class="dsp-input"
                       [(ngModel)]="link.title"
                       (input)="onRecipeChange()"
                       placeholder="Link title">
                <input type="text"
                       class="dsp-input"
                       [(ngModel)]="link.url"
                       (input)="onRecipeChange()"
                       placeholder="URL or Recipe ID">
                <button type="button" 
                        class="btn btn-sm btn-danger"
                        (click)="removeQuickLink(i, j)">−</button>
              </div>
              <button type="button" 
                      class="btn btn-sm btn-secondary"
                      (click)="addQuickLink(i)">+ Add Link</button>
            </div>

            <button type="button" 
                    class="btn btn-sm btn-danger"
                    (click)="removePrerequisite(i)">Remove Prerequisite</button>
          </div>

          <button type="button" 
                  class="btn btn-secondary"
                  (click)="addPrerequisite()">+ Add Prerequisite</button>
        </div>

        <!-- Walkthrough -->
        <div class="form-section">
          <h2>Walkthrough</h2>
          
          <div class="step-item" 
               *ngFor="let step of currentRecipe.walkthrough; let i = index; trackBy: trackByIndex"
               [attr.data-step-index]="i">
            <div class="step-header">
              <h3>Step {{ i + 1 }}</h3>
              <div class="step-actions">
                <button type="button" 
                        class="btn btn-sm btn-secondary"
                        [disabled]="i === 0"
                        (click)="moveStepUp(i)">↑</button>
                <button type="button" 
                        class="btn btn-sm btn-secondary"
                        [disabled]="i === currentRecipe.walkthrough.length - 1"
                        (click)="moveStepDown(i)">↓</button>
                <button type="button" 
                        class="btn btn-sm btn-danger"
                        (click)="removeStep(i)">Remove</button>
              </div>
            </div>

            <div class="form-group">
              <label>Step Name</label>
              <select class="dsp-input"
                      [(ngModel)]="step.step"
                      (change)="onRecipeChange()">
                <option value="">Select step</option>
                <option *ngFor="let option of stepOptions" [value]="option">{{ option }}</option>
              </select>
            </div>

            <!-- Configuration -->
            <div class="config-section">
              <h4>Configuration</h4>
              <div class="config-item" 
                   *ngFor="let config of step.config; let j = index; trackBy: trackByIndex">
                <div class="autocomplete-wrapper">
                  <input type="text"
                         class="dsp-input config-field"
                         [(ngModel)]="config.field"
                         (input)="onRecipeChange(); handleFieldAutocomplete($event, i)"
                         (focus)="handleFieldAutocomplete($event, i)"
                         (blur)="closeAutocomplete($event)"
                         (keydown)="handleAutocompleteKeydown($event)"
                         placeholder="Field name">
                </div>
                <input type="text"
                       class="dsp-input"
                       [(ngModel)]="config.value"
                       (input)="onRecipeChange()"
                       placeholder="Value">
                <button type="button" 
                        class="btn btn-sm btn-danger"
                        (click)="removeConfig(i, j)">−</button>
              </div>
              <button type="button" 
                      class="btn btn-sm btn-secondary"
                      (click)="addConfig(i)">+ Add Config</button>
            </div>

            <!-- Media -->
            <div class="media-section">
              <h4>Media</h4>
              <div class="media-item" 
                   *ngFor="let media of step.media; let j = index; trackBy: trackByIndex">
                <div class="media-row">
                  <select class="dsp-input"
                          [(ngModel)]="media.type"
                          (change)="onRecipeChange()">
                    <option value="image">Image</option>
                    <option value="video">Video</option>
                  </select>
                  <input type="text"
                         class="dsp-input"
                         [(ngModel)]="media.url"
                         (input)="onRecipeChange()"
                         placeholder="URL or path">
                  <input type="text"
                         class="dsp-input"
                         [(ngModel)]="media.alt"
                         (input)="onRecipeChange()"
                         placeholder="Alt text">
                  <button type="button" 
                          class="btn btn-sm btn-danger"
                          (click)="removeMedia(i, j)">−</button>
                </div>
                <!-- Image Preview for uploaded images -->
                <div class="media-preview" 
                     *ngIf="media.type === 'image' && media.url && media.url.startsWith('images/')">
                  <img [src]="media.displayUrl || media.url" 
                       [alt]="media.alt"
                       class="media-preview-image clickable-image"
                       (click)="openImagePreview(media.displayUrl || media.url, media.alt)"
                       title="Click to enlarge"
                       (error)="onImageError($event)"
                       (load)="loadImageForMedia(media)">
                </div>
              </div>
              
              <!-- Image Upload -->
              <div class="image-upload-area"
                   (dragover)="$event.preventDefault()"
                   (drop)="onImageDrop($event, i)">
                <p>Drag and drop images here, or</p>
                <input type="file"
                       #imageInput
                       accept="image/*"
                       style="display: none"
                       (change)="handleImageFile($any($event.target).files[0], i)">
                <button type="button" 
                        class="btn btn-sm btn-secondary"
                        (click)="imageInput.click()">Upload Image</button>
              </div>
            </div>
          </div>

          <button type="button" 
                  class="btn btn-secondary"
                  (click)="addStep()">+ Add Step</button>
        </div>
      </div>
    </div>

    <!-- Right - JSON Preview -->
    <div class="preview-panel" *ngIf="currentRecipe">
      <h3>JSON Preview</h3>
      <div class="json-preview">
        <pre><code>{{ jsonPreview }}</code></pre>
      </div>
      <button class="btn btn-sm btn-secondary copy-btn"
              (click)="copyToClipboard(jsonPreview)">
        Copy JSON
      </button>
    </div>
  </div>

  <!-- No Selection Message -->
  <div class="no-selection" *ngIf="!currentRecipe && !state.isLoading">
    <p>Create a new recipe or select one from the list to start editing</p>
    <button class="btn btn-primary" (click)="createNewTab()">Create New Recipe</button>
  </div>

  <!-- Hidden file input for import -->
  <input type="file" 
         #fileInput
         accept=".json"
         style="display: none"
         (change)="importRecipe($event)">

  <!-- Image Preview Modal -->
  <div class="image-preview-modal" 
       [class.show]="imagePreviewState.isOpen"
       (click)="closeImagePreview($event)">
    <div class="image-preview-backdrop"></div>
    <div class="image-preview-content" (click)="$event.stopPropagation()">
      <button class="image-preview-close" 
              (click)="closeImagePreview()"
              title="Close (ESC)">×</button>
      <img [src]="imagePreviewState.imageUrl" 
           [alt]="imagePreviewState.altText"
           [style.transform]="'scale(' + imagePreviewState.zoomLevel + ')'"
           class="preview-image">
      <div class="image-preview-controls">
        <button class="zoom-btn" 
                (click)="zoomIn()"
                title="Zoom In (+)">🔍+</button>
        <button class="zoom-btn" 
                (click)="zoomOut()"
                title="Zoom Out (-)">🔍-</button>
        <button class="zoom-btn" 
                (click)="resetZoom()"
                title="Reset Zoom (0)">↻</button>
      </div>
    </div>
  </div>
</div>