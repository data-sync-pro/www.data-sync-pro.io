<div class="recipe-editor-container">
  <!-- Header Bar -->
  <div class="editor-header">
    <div class="editor-brand">
      <a routerLink="/" class="brand-link" title="Return to Data Sync Pro">
        <img src="assets/logo.png" alt="Data Sync Pro" class="brand-logo">
        <span class="brand-text">DSP</span>
      </a>
      <h1 class="editor-title">Recipe Editor</h1>
    </div>
    
    <div class="editor-stats">
      <span class="stat-item">
        <strong>{{ recipeList.length }}</strong> Total Recipes
      </span>
      <span class="stat-item created tooltip-container" 
            *ngIf="getCreatedCount() > 0"
            (mouseenter)="onTooltipEnter('created')" 
            (mouseleave)="onTooltipLeave()">
        <strong>{{ getCreatedCount() }}</strong> Created
        <div class="tooltip-content" *ngIf="showTooltip === 'created'"
             (mouseenter)="onTooltipEnter('created')"
             (mouseleave)="onTooltipLeave()">
          <div class="tooltip-header">Created Recipes:</div>
          <div class="tooltip-item clickable" 
               *ngFor="let item of getCreatedRecipeTitles()"
               (click)="onTooltipRecipeClick(item.recipeId); $event.stopPropagation()"
               title="Click to edit this recipe">
            {{ item.title }}
          </div>
          <div class="tooltip-more" *ngIf="getCreatedCount() > 10">
            ...and {{ getCreatedCount() - 10 }} more
          </div>
        </div>
      </span>
      <span class="stat-item edited tooltip-container" 
            *ngIf="getEditedExistingCount() > 0"
            (mouseenter)="onTooltipEnter('edited')" 
            (mouseleave)="onTooltipLeave()">
        <strong>{{ getEditedExistingCount() }}</strong> Edited
        <div class="tooltip-content" *ngIf="showTooltip === 'edited'"
             (mouseenter)="onTooltipEnter('edited')"
             (mouseleave)="onTooltipLeave()">
          <div class="tooltip-header">Edited Recipes:</div>
          <div class="tooltip-item clickable" 
               *ngFor="let item of getEditedExistingRecipeTitles()"
               (click)="onTooltipRecipeClick(item.recipeId); $event.stopPropagation()"
               title="Click to edit this recipe">
            {{ item.title }}
          </div>
          <div class="tooltip-more" *ngIf="getEditedExistingCount() > 10">
            ...and {{ getEditedExistingCount() - 10 }} more
          </div>
        </div>
      </span>
      <span class="stat-item" *ngIf="state.lastSaved">
        Last saved: {{ state.lastSaved | date:'short' }}
      </span>
    </div>

    <div class="editor-actions">
      <button class="btn btn-secondary" 
              (click)="triggerImport()"
              [disabled]="state.isImporting">
        <span *ngIf="!state.isImporting">Import Recipe</span>
        <span *ngIf="state.isImporting">Importing...</span>
      </button>
      <button class="btn btn-primary" (click)="exportCurrentRecipe()"
              [disabled]="!currentRecipe || state.isImporting">
        Export Current
      </button>
      <button class="btn btn-primary" (click)="exportAllRecipes()"
              [disabled]="editedRecipeIds.size === 0 || state.isImporting">
        Export All ({{ editedRecipeIds.size }})
      </button>
      <button class="btn btn-success" (click)="saveAllTabs()"
              [disabled]="!hasUnsavedChanges() || state.isImporting">
        Save All
      </button>
      <button class="btn btn-danger" 
              (click)="clearAllData()"
              [disabled]="state.isImporting">
        Clear All Data
      </button>
    </div>
  </div>

  <!-- Import Progress Bar -->
  <div class="import-progress-overlay" 
       *ngIf="state.isImporting"
       [ngClass]="{'show': state.isImporting}">
    <div class="import-progress-dialog">
      <h3>Importing Recipes</h3>
      <div class="progress-bar-container" *ngIf="state.importProgress">
        <div class="progress-bar">
          <div class="progress-fill" 
               [style.width.%]="state.importProgress.percentage"></div>
        </div>
        <div class="progress-text">
          {{ state.importProgress.step }} ({{ state.importProgress.current }}/{{ state.importProgress.total }})
        </div>
        <div class="progress-percentage">{{ state.importProgress.percentage }}%</div>
      </div>
      <div class="loading-spinner" *ngIf="!state.importProgress">
        <div class="spinner"></div>
        <div>Reading ZIP file...</div>
      </div>
    </div>
  </div>

  <!-- Tabs Container -->
  <div class="tabs-container" *ngIf="state.tabs.length > 0">
    <div class="tabs">
      <div class="tab" 
           *ngFor="let tab of state.tabs; trackBy: trackByIndex"
           [class.active]="tab.isActive"
           [class.has-changes]="tab.hasChanges"
           (click)="selectTab(tab.id)">
        <span class="tab-title">{{ tab.title }}</span>
        <span class="changes-indicator" *ngIf="tab.hasChanges">‚óè</span>
        <button class="close-tab" 
                *ngIf="state.tabs.length > 1"
                (click)="closeTab(tab.id); $event.stopPropagation()">√ó</button>
      </div>
      <button class="add-tab" (click)="createNewTab()">+ Add Recipe</button>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="editor-main">
    <!-- Left Sidebar - Recipe List -->
    <div class="recipe-list-panel">
      <!-- Search and Filter -->
      <div class="list-controls">
        <input type="text" 
               class="dsp-input dsp-input--search"
               placeholder="Search recipes..."
               [(ngModel)]="searchQuery"
               (input)="filterRecipes()">
        
        <select class="category-filter"
                [(ngModel)]="selectedCategory"
                (change)="filterRecipes()">
          <option value="">All Categories</option>
          <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
        </select>
      </div>

      <!-- Recipe List -->
      <div class="recipe-list">
        <div class="recipe-item"
             *ngFor="let recipe of filteredRecipes"
             [class.edited]="isRecipeEdited(recipe.id)"
             [class.inactive]="!isRecipeActive(recipe.id)"
             (click)="loadRecipeToEditor(recipe)">
          <div class="recipe-item-header">
            <span class="status-indicator inactive" *ngIf="!isRecipeActive(recipe.id)" title="Inactive Recipe">üö´</span>
            <span class="edit-indicator" *ngIf="isRecipeEdited(recipe.id)">‚úèÔ∏è</span>
          </div>
          <div class="recipe-title">{{ recipe.title }}</div>
          <div class="recipe-category">{{ recipe.category }}</div>
        </div>
      </div>
    </div>

    <!-- Middle - Editor -->
    <div class="editor-panel" *ngIf="currentRecipe">
      <!-- Loading indicator -->
      <div class="loading-indicator" *ngIf="state.isLoading">
        <p>Loading recipe...</p>
      </div>

      <div class="recipe-form" *ngIf="!state.isLoading">
        <!-- Basic Information -->
        <div class="form-section">
          <h2>Basic Information</h2>
          
          <div class="form-row">
            <div class="form-group active-field">
              <label class="checkbox-label">
                <input type="checkbox" 
                       [(ngModel)]="currentIsActive"
                       (change)="onRecipeChange()">
                <span class="checkbox-text">Active</span>
              </label>
            </div>
            
            <div class="form-group">
              <label for="title">Title *</label>
              <input type="text" 
                     id="title"
                     class="dsp-input"
                     [(ngModel)]="currentRecipe.title"
                     (input)="onRecipeChange()"
                     required>
            </div>
            
            <div class="form-group">
              <label for="category">Category *</label>
              <select id="category"
                      class="dsp-input"
                      [(ngModel)]="currentRecipe.category"
                      (change)="onRecipeChange()"
                      required>
                <option value="">Select category</option>
                <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="overview">Overview *</label>
            <textarea id="overview"
                      class="dsp-input"
                      rows="3"
                      [(ngModel)]="currentRecipe.overview"
                      (input)="onRecipeChange()"
                      placeholder="Detailed overview of what this recipe does"
                      required></textarea>
          </div>

          <div class="form-group">
            <label for="whenToUse">General Use Case</label>
            <textarea id="whenToUse"
                      class="dsp-input"
                      rows="3"
                      [(ngModel)]="currentRecipe.whenToUse"
                      (input)="onRecipeChange()"
                      placeholder="Describe when this recipe should be used"></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="direction">Direction</label>
              <input type="text"
                     id="direction"
                     class="dsp-input"
                     [(ngModel)]="currentRecipe.direction"
                     (input)="onRecipeChange()"
                     placeholder="e.g. Current ‚áí Current">
            </div>
            
            <div class="form-group">
              <label for="connection">Connection</label>
              <input type="text"
                     id="connection"
                     class="dsp-input"
                     [(ngModel)]="currentRecipe.connection"
                     (input)="onRecipeChange()">
            </div>
          </div>

          <!-- DSP Versions -->
          <div class="form-group">
            <label>DSP Versions</label>
            <div class="dynamic-list">
              <div class="dynamic-item" 
                   *ngFor="let version of currentRecipe.DSPVersions; let i = index; trackBy: trackByIndex">
                <input type="text"
                       class="dsp-input"
                       [(ngModel)]="currentRecipe.DSPVersions[i]"
                       (input)="onRecipeChange()"
                       placeholder="Version">
                <button type="button" 
                        class="btn btn-sm btn-danger"
                        (click)="removeDSPVersion(i)">‚àí</button>
              </div>
              <button type="button" 
                      class="btn btn-sm btn-secondary"
                      (click)="addDSPVersion()">+ Add Version</button>
            </div>
          </div>

          <!-- Keywords -->
          <div class="form-group">
            <label>Keywords</label>
            <div class="dynamic-list">
              <div class="dynamic-item" 
                   *ngFor="let keyword of currentRecipe.keywords; let i = index; trackBy: trackByIndex">
                <input type="text"
                       class="dsp-input"
                       [(ngModel)]="currentRecipe.keywords[i]"
                       (input)="onRecipeChange()"
                       placeholder="Keyword">
                <button type="button" 
                        class="btn btn-sm btn-danger"
                        (click)="removeKeyword(i)">‚àí</button>
              </div>
              <button type="button" 
                      class="btn btn-sm btn-secondary"
                      (click)="addKeyword()">+ Add Keyword</button>
            </div>
          </div>

          <!-- Downloadable Executables -->
          <div class="form-group">
            <label>Downloadable Executables</label>
            <div class="downloadable-executables">
              <div class="downloadable-item" 
                   *ngFor="let executable of currentRecipe.downloadableExecutables; let i = index; trackBy: trackByIndex">
                <div class="json-upload-area"
                     [class.has-json]="executable.filePath"
                     (drop)="onJsonFileDrop($event, i)"
                     (dragover)="onJsonFileDragOver($event)"
                     (dragleave)="onJsonFileDragLeave($event)"
                     (click)="triggerJsonFileInput(i)">
                  <input type="file" 
                         [id]="'json-upload-' + i"
                         class="json-upload"
                         accept=".json"
                         style="display: none"
                         (change)="onJsonFileSelect($event, i)">
                  <div class="upload-placeholder" 
                       [class.uploaded]="executable.filePath">
                    <ng-container *ngIf="!executable.filePath">
                      Click or drag to upload JSON file
                    </ng-container>
                    <ng-container *ngIf="executable.filePath">
                      ‚úì {{ getJsonFileName(executable) }}
                    </ng-container>
                  </div>
                </div>
                <button type="button" 
                        class="btn btn-sm btn-danger"
                        (click)="removeDownloadableExecutable(i)">‚àí</button>
              </div>
              <button type="button" 
                      class="btn btn-sm btn-secondary"
                      (click)="addDownloadableExecutable()">+ Add File</button>
            </div>
          </div>

          <!-- Related Recipes -->
          <div class="form-group">
            <label>Related Recipes</label>
            <div class="dynamic-list">
              <div class="related-item" 
                   *ngFor="let related of currentRecipe.relatedRecipes; let i = index; trackBy: trackByIndex">
                <input type="text"
                       class="dsp-input"
                       [(ngModel)]="related.title"
                       (input)="onRecipeChange()"
                       placeholder="Recipe Title">
                <input type="text"
                       class="dsp-input"
                       [(ngModel)]="related.url"
                       (input)="onRecipeChange()"
                       placeholder="Recipe URL">
                <button type="button" 
                        class="btn btn-sm btn-danger"
                        (click)="removeRelatedRecipe(i)">‚àí</button>
              </div>
              <button type="button" 
                      class="btn btn-sm btn-secondary"
                      (click)="addRelatedRecipe()">+ Add Related Recipe</button>
            </div>
          </div>

          <!-- General Images -->
          <div class="form-group">
            <label>General Images</label>
            <div class="general-images-container" appSimpleZoomable>
              <div class="general-images-list">
                <div class="general-image-item" 
                     *ngFor="let image of currentRecipe.generalImages; let i = index; trackBy: trackByIndex">
                  <div class="media-row">
                    <select class="dsp-input"
                            [(ngModel)]="image.type"
                            (change)="onRecipeChange()">
                      <option value="image">Image</option>
                      <option value="video">Video</option>
                      <option value="gif">GIF</option>
                    </select>
                    <input type="text"
                           class="dsp-input"
                           [(ngModel)]="image.url"
                           (input)="onRecipeChange()"
                           placeholder="URL or path">
                    <input type="text"
                           class="dsp-input"
                           [(ngModel)]="image.alt"
                           (input)="onRecipeChange()"
                           placeholder="Alt text or description">
                    <button type="button" 
                            class="btn btn-sm btn-danger"
                            (click)="removeGeneralImage(i)">‚àí</button>
                  </div>
                  <!-- Image Preview for uploaded images -->
                  <div class="media-preview" 
                       *ngIf="image.type === 'image' && image.url && (image.url.startsWith('images/') || image.url.startsWith('assets/'))">
                    <div *ngIf="image.displayUrl; else loadingGeneralImage">
                      <img [src]="image.displayUrl" 
                           [alt]="image.alt"
                           class="media-preview-image"
                           title="Click to enlarge"
                           (error)="onImageError($event)">
                    </div>
                    <ng-template #loadingGeneralImage>
                      <div class="image-loading-placeholder" 
                           [class.missing]="isImageMissing(image)"
                           (click)="handleMissingGeneralImage(image, i)"
                           [title]="isImageMissing(image) ? 'Image missing - click to upload replacement' : 'Click to load image'">
                        <span *ngIf="!isImageMissing(image)">üì∏ Loading image...</span>
                        <span *ngIf="isImageMissing(image)">‚ö†Ô∏è Image missing - click to upload</span>
                        <input type="file" 
                               [id]="'missing-general-' + i"
                               style="display: none"
                               accept="image/*"
                               (change)="replaceMissingGeneralImage($event, image, i)">
                      </div>
                    </ng-template>
                  </div>
                </div>
              </div>
              
              <!-- Upload Area and Add Button -->
              <div class="image-upload-area"
                   (dragover)="$event.preventDefault()"
                   (drop)="onGeneralImageDrop($event)">
                <p>Drag and drop images here, or</p>
                <input type="file"
                       #generalImageInput
                       accept="image/*,video/*"
                       style="display: none"
                       (change)="handleGeneralImageFile($any($event.target).files[0])">
                <button type="button" 
                        class="btn btn-sm btn-secondary"
                        (click)="generalImageInput.click()">Upload File</button>
                <button type="button" 
                        class="btn btn-sm btn-secondary"
                        (click)="addGeneralImage()">+ Add Media</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Prerequisites -->
        <div class="form-section">
          <h2>Prerequisites</h2>
          
          <div class="prerequisite-item" 
               *ngFor="let prereq of currentRecipe.prerequisites; let i = index; trackBy: trackByIndex">
            <div class="form-group">
              <label>Description</label>
              <input type="text"
                     class="dsp-input"
                     [(ngModel)]="prereq.description"
                     (input)="onRecipeChange()"
                     placeholder="Prerequisite description">
            </div>

            <!-- Quick Links -->
            <div class="quick-links">
              <label>Quick Links</label>
              <div class="quick-link" 
                   *ngFor="let link of prereq.quickLinks; let j = index; trackBy: trackByIndex">
                <input type="text"
                       class="dsp-input"
                       [(ngModel)]="link.title"
                       (input)="onRecipeChange()"
                       placeholder="Link title">
                <input type="text"
                       class="dsp-input"
                       [(ngModel)]="link.url"
                       (input)="onRecipeChange()"
                       placeholder="URL or Recipe ID">
                <button type="button" 
                        class="btn btn-sm btn-danger"
                        (click)="removeQuickLink(i, j)">‚àí</button>
              </div>
              <button type="button" 
                      class="btn btn-sm btn-secondary"
                      (click)="addQuickLink(i)">+ Add Link</button>
            </div>

            <button type="button" 
                    class="btn btn-sm btn-danger"
                    (click)="removePrerequisite(i)">Remove Prerequisite</button>
          </div>

          <button type="button" 
                  class="btn btn-secondary"
                  (click)="addPrerequisite()">+ Add Prerequisite</button>
        </div>

        <!-- Walkthrough -->
        <div class="form-section">
          <h2>Walkthrough</h2>
          
          <div class="step-item" 
               *ngFor="let step of currentRecipe.walkthrough; let i = index; trackBy: trackByIndex"
               [attr.data-step-index]="i">
            <div class="step-header" (click)="toggleStep(i)">
              <div class="step-title-section">
                <span class="step-toggle-icon">{{ isStepExpanded(i) ? '‚ñº' : '‚ñ∂' }}</span>
                <h3>{{ getStepTitle(step, i) }}</h3>
              </div>
              <div class="step-actions" (click)="$event.stopPropagation()">
                <button type="button" 
                        class="btn btn-sm btn-secondary"
                        [disabled]="i === 0"
                        (click)="moveStepUp(i)">‚Üë</button>
                <button type="button" 
                        class="btn btn-sm btn-secondary"
                        [disabled]="i === currentRecipe.walkthrough.length - 1"
                        (click)="moveStepDown(i)">‚Üì</button>
                <button type="button" 
                        class="btn btn-sm btn-danger"
                        (click)="removeStep(i)">Remove</button>
              </div>
            </div>

            <div class="step-content" *ngIf="isStepExpanded(i)">
              <div class="form-group">
                <label>Step Name</label>
                <select class="dsp-input"
                        [(ngModel)]="step.step"
                        (change)="onStepSelectionChange(step, i)">
                  <option value="">Select step</option>
                  <option *ngFor="let option of stepOptions" [value]="option">{{ option }}</option>
                </select>
              </div>

              <div class="form-group" *ngIf="step.step === 'Custom'">
                <label>Custom Step Name</label>
                <input type="text" 
                       class="dsp-input"
                       [(ngModel)]="customStepNames[i]"
                       (input)="onCustomStepNameChange(i)"
                       placeholder="Enter custom step name"
                       #customStepInput>
              </div>

            <!-- Configuration -->
            <div class="config-section">
              <h4>Configuration</h4>
              <div class="config-item" 
                   *ngFor="let config of step.config; let j = index; trackBy: trackByIndex">
                <div class="autocomplete-wrapper">
                  <input type="text"
                         class="dsp-input config-field"
                         [(ngModel)]="config.field"
                         (input)="onRecipeChange(); handleFieldAutocomplete($event, i)"
                         (focus)="handleFieldAutocomplete($event, i)"
                         (blur)="closeAutocomplete($event)"
                         (keydown)="handleAutocompleteKeydown($event)"
                         placeholder="Field name">
                </div>
                <input type="text"
                       class="dsp-input"
                       [(ngModel)]="config.value"
                       (input)="onRecipeChange()"
                       placeholder="Value">
                <button type="button" 
                        class="btn btn-sm btn-danger"
                        (click)="removeConfig(i, j)">‚àí</button>
              </div>
              <button type="button" 
                      class="btn btn-sm btn-secondary"
                      (click)="addConfig(i)">+ Add Config</button>
            </div>

            <!-- Media -->
            <div class="media-section" appSimpleZoomable>
              <h4>Media</h4>
              <div class="media-item" 
                   *ngFor="let media of step.media; let j = index; trackBy: trackByIndex">
                <div class="media-row">
                  <select class="dsp-input"
                          [(ngModel)]="media.type"
                          (change)="onRecipeChange()">
                    <option value="image">Image</option>
                    <option value="video">Video</option>
                  </select>
                  <input type="text"
                         class="dsp-input"
                         [(ngModel)]="media.url"
                         (input)="onRecipeChange()"
                         placeholder="URL or path">
                  <input type="text"
                         class="dsp-input"
                         [(ngModel)]="media.alt"
                         (input)="onRecipeChange()"
                         placeholder="Alt text">
                  <button type="button" 
                          class="btn btn-sm btn-danger"
                          (click)="removeMedia(i, j)">‚àí</button>
                </div>
                <!-- Image Preview for uploaded images and assets images -->
                <div class="media-preview" 
                     *ngIf="media.type === 'image' && media.url && (media.url.startsWith('images/') || media.url.startsWith('assets/'))">
                  <div *ngIf="media.displayUrl; else loadingImage">
                    <img [src]="media.displayUrl" 
                         [alt]="media.alt"
                         class="media-preview-image"
                         title="Click to enlarge"
                         (error)="onImageError($event)">
                  </div>
                  <ng-template #loadingImage>
                    <div class="image-loading-placeholder" 
                         [class.missing]="isImageMissing(media)"
                         (click)="handleMissingImage(media, i)"
                         [title]="isImageMissing(media) ? 'Image missing - click to upload replacement' : 'Click to load image'">
                      <span *ngIf="!isImageMissing(media)">üì∏ Loading image...</span>
                      <span *ngIf="isImageMissing(media)">‚ö†Ô∏è Image missing - click to upload</span>
                      <input type="file" 
                             [id]="'missing-media-' + i"
                             style="display: none"
                             accept="image/*"
                             (change)="replaceMissingImage($event, media, i)">
                    </div>
                  </ng-template>
                </div>
              </div>
              
              <!-- Upload Area and Add Button -->
              <div class="image-upload-area"
                   (dragover)="$event.preventDefault()"
                   (drop)="onImageDrop($event, i)">
                <p>Drag and drop images here, or</p>
                <input type="file"
                       #imageInput
                       accept="image/*,video/*"
                       style="display: none"
                       (change)="handleImageFile($any($event.target).files[0], i)">
                <button type="button" 
                        class="btn btn-sm btn-secondary"
                        (click)="imageInput.click()">Upload File</button>
                <button type="button" 
                        class="btn btn-sm btn-secondary"
                        (click)="addMedia(i)">+ Add Media</button>
              </div>
            </div>
            </div>
          </div>

          <button type="button" 
                  class="btn btn-secondary"
                  (click)="addStep()">+ Add Step</button>
        </div>
      </div>
    </div>

    <!-- Right - Preview Panel -->
    <div class="preview-panel" *ngIf="currentRecipe">
      <div class="preview-header">
        <h3>Preview</h3>
        <div class="preview-actions">
          <button class="btn btn-sm btn-primary preview-new-tab"
                  (click)="openPreviewInNewTab()"
                  title="Open preview in new tab">
            <span class="btn-icon">üóó</span>
            Open Preview
          </button>
        </div>
      </div>
      
      <!-- JSON Preview Content -->
      <div class="json-preview">
        <pre><code>{{ jsonPreview }}</code></pre>
        <button class="btn btn-sm btn-secondary copy-btn"
                (click)="copyToClipboard(jsonPreview)"
                title="Copy JSON to clipboard">
          Copy JSON
        </button>
      </div>
    </div>
  </div>

  <!-- No Selection Message -->
  <div class="no-selection" *ngIf="!currentRecipe && !state.isLoading">
    <p>Create a new recipe or select one from the list to start editing</p>
    <button class="btn btn-primary" (click)="createNewTab()">Create New Recipe</button>
  </div>

  <!-- Hidden file input for import -->
  <input type="file" 
         #fileInput
         accept=".json,.zip"
         style="display: none"
         (change)="importRecipe($event)">

</div>