<div class="recipe-layout-container"
     [class.sidebar-collapsed]="ui.sidebarCollapsed"
     [class.toc-hidden]="ui.tocHidden">

  <!-- Recipe Sidebar Component -->
  <app-recipe-sidebar
    [uiState]="ui"
    [categories]="categories"
    [navigation]="navigation"
    [recipeCount]="getRecipeCount()"
    [searchQuery]="search.query"
    (sidebarToggle)="toggleSidebar()"
    (mobileSidebarToggle)="toggleMobileSidebar()"
    (mobileSidebarClose)="closeMobileSidebar()"
    (homeClick)="goHome()"
    (categoryClick)="goToCategory($event)"
    (searchClick)="openSearchOverlay($event)">
  </app-recipe-sidebar>

  <!-- Breadcrumb Navigation -->
  <nav class="breadcrumb-nav" *ngIf="breadcrumbPath.length > 1" aria-label="breadcrumb">
    <div class="breadcrumb">
      <ng-container *ngFor="let crumb of breadcrumbPath; trackBy: trackByBreadcrumbUrl; let last = last; let first = first">
        <button class="breadcrumb-item"
                [class.active]="last && !showRecipeDetails"
                [routerLink]="crumb.url"
                [disabled]="false"
                [title]="'Go to ' + crumb.name">
          <lightning-icon *ngIf="first" iconName="utility:home" size="xx-small" alternativeText="Home"></lightning-icon>
          <span>{{ crumb.name }}</span>
        </button>

        <span class="breadcrumb-separator" *ngIf="!last">
          <lightning-icon iconName="utility:chevronright" size="xx-small" alternativeText="Next"></lightning-icon>
        </span>
      </ng-container>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="recipe-main">

      <!-- Loading State -->
      <div *ngIf="ui.isLoading" class="loading-container">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        <p>Loading recipes...</p>
      </div>

      <!-- Home View - All Recipes -->
      <div *ngIf="showHome && !ui.isLoading" class="recipe-home">
        <div class="home-header">
          <h2 class="section-title">All Recipes</h2>
         </div>

        <!-- Recipe Grid -->
        <div class="recipe-grid" *ngIf="currentRecipes.length > 0">
          <app-recipe-card
            *ngFor="let recipe of currentRecipes; trackBy: trackByRecipeId"
            [recipe]="recipe"
            (recipeSelect)="goToRecipe($event)">
          </app-recipe-card>
        </div>

        <!-- No Results -->
        <div class="no-results" *ngIf="currentRecipes.length === 0">
          <mat-icon>search_off</mat-icon>
          <h3>No recipes found</h3>
          <p>No recipes are currently available.</p>
        </div>

      </div>

      <!-- Category View - Recipes in Category -->
      <div *ngIf="showCategory && !ui.isLoading" class="recipe-category-view">
        <div class="category-header" *ngIf="currentCategory">
          <h2 class="category-title">{{ currentCategory.displayName }} Recipes</h2>
          <p class="category-description">{{ currentCategory.description }}</p>
        </div>

        <!-- Recipe Grid -->
        <div class="recipe-grid" *ngIf="currentRecipes.length > 0">
          <app-recipe-card
            *ngFor="let recipe of currentRecipes; trackBy: trackByRecipeId"
            [recipe]="recipe"
            (recipeSelect)="goToRecipe($event)">
          </app-recipe-card>
        </div>

        <!-- No Results -->
        <div class="no-results" *ngIf="currentRecipes.length === 0">
          <mat-icon>search_off</mat-icon>
          <h3>No recipes found</h3>
          <p>No recipes match your current search criteria.</p>
        </div>
      </div>

      <!-- Recipe Detail View -->
      <div *ngIf="showRecipeDetails && !ui.isLoading" class="recipe-detail-view">
        
        <div class="recipe-detail">
          <!-- Recipe Header -->
          <div class="recipe-header">
            <div class="header-content">
              <h1>{{ currentRecipe?.title }}</h1>
            </div>
          </div>


          <!-- Recipe Content -->
          <div class="recipe-content">
            
            <!-- Unified Recipe Content - Overview + Walkthrough -->
            <div class="recipe-unified-content">

              <!-- Overview Sections -->
              <div class="overview-sections">
                <app-recipe-overview-section
                  *ngFor="let sectionConfig of getVisibleOverviewSections(); trackBy: trackBySectionId"
                  [section]="sectionConfig"
                  (downloadClick)="downloadExecutable($event.url, $event.title, $event.fileName)">
                </app-recipe-overview-section>
              </div>

              <!-- Walkthrough Sections -->
              <div class="walkthrough-sections" *ngIf="walkthroughSteps.length > 0">
                <app-recipe-step
                  *ngFor="let step of walkthroughStepsData; let i = index; trackBy: trackByStepIndex"
                  [stepData]="step"
                  [stepId]="'step-' + i"
                  [stepIndex]="i"
                  [attr.data-step-index]="i">
                </app-recipe-step>
              </div>

              <!-- No Steps Available -->
              <div class="no-steps" *ngIf="walkthroughSteps.length === 0">
                <mat-icon>info</mat-icon>
                <h3>No walkthrough steps available</h3>
                <p>This recipe doesn't have detailed walkthrough steps configured.</p>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- Search Results -->
      <div *ngIf="search.isActive && !ui.isLoading" class="search-results">
        <div class="search-header">
          <h2 class="search-title">Search Results for "{{ search.query }}"</h2>
          <p class="search-summary">
            {{ search.results.length }} {{ search.results.length === 1 ? 'recipe' : 'recipes' }} found
          </p>
        </div>

        <div class="recipe-grid" *ngIf="search.hasResults">
          <app-recipe-card
            *ngFor="let searchResult of search.results; trackBy: trackByRecipeId"
            [recipe]="searchResult"
            (recipeSelect)="goToRecipe($event)">
          </app-recipe-card>
        </div>

        <div class="no-results" *ngIf="!search.hasResults">
          <mat-icon>search_off</mat-icon>
          <h3>No recipes found</h3>
          <p>Try adjusting your search terms or browse by category.</p>
          <button mat-raised-button color="primary" (click)="clearSearch()">
            Browse All Recipes
          </button>
        </div>
      </div>

  </main>

  <!-- Right TOC (Table of Contents) - Microsoft Learn Style -->
  <app-recipe-toc
    [overviewSections]="getOverviewSectionsForTOC()"
    [walkthroughSections]="getWalkthroughSectionsForTOC()"
    [activeSectionId]="ui.activeSectionId"
    [visible]="showRecipeDetails"
    (overviewSectionClick)="navigateToOverviewSection($event)"
    (walkthroughSectionClick)="navigateToWalkthroughSection($event)">
  </app-recipe-toc>


</div>

<!-- Recipe Search Overlay -->
<app-recipe-search-overlay
  *ngIf="search.isOverlayOpen"
  [isOpen]="search.isOverlayOpen"
  [initialQuery]="searchOverlayInitialQuery"
  (closed)="closeSearchOverlay()"
  (selectedResult)="handleSearchOverlaySelect($event)">
</app-recipe-search-overlay>