# FAQ编辑器撤回功能改进

## 改进概述

将FAQ编辑器的撤回/重做功能从自定义实现改为使用浏览器原生的撤回系统，避免了DOM重建带来的性能问题。

## 主要改进

### 1. 使用原生撤回系统
- **之前**：使用自定义的`UndoRedoManager`保存完整HTML快照，通过`innerHTML`替换整个DOM
- **现在**：优先使用`document.execCommand('undo'/'redo')`，让浏览器管理撤回历史

### 2. 性能优化
- **避免DOM重建**：不再通过innerHTML替换整个DOM树
- **保持光标位置**：浏览器自动维护光标和选择状态
- **减少内存占用**：不再保存完整HTML快照

### 3. 简化的操作方法
- **格式化操作**：使用`execCommand('insertHTML')`使格式化可撤回
- **文本格式**：直接使用`execCommand('bold'/'italic'/'underline')`
- **插入操作**：统一使用`insertHTML`命令，自动创建撤回点

## 技术实现细节

### 撤回/重做方法
```typescript
performUndo(): void {
  // 优先使用原生撤回
  const success = document.execCommand('undo', false);
  if (!success) {
    // 降级到自定义撤回管理器（保留作为备用）
  }
}
```

### 格式化操作
```typescript
formatHTML(): void {
  // 选择全部内容
  document.execCommand('selectAll', false);
  // 插入格式化后的内容（自动创建撤回点）
  document.execCommand('insertHTML', false, formatted);
}
```

## 测试场景

### 基本编辑测试
1. **文本输入撤回**
   - 输入一段文本
   - 按Ctrl+Z撤回
   - 按Ctrl+Y重做
   - 验证文本正确恢复

2. **格式化撤回**
   - 选择文本，应用粗体/斜体/下划线
   - 撤回格式化
   - 验证格式正确移除

3. **HTML格式化撤回**
   - 使用Alt+Shift+F格式化HTML
   - 撤回格式化
   - 验证内容恢复到格式化前

4. **链接插入撤回**
   - 选择文本，按Ctrl+K插入链接
   - 撤回链接插入
   - 验证链接被移除

5. **复杂操作序列**
   - 连续执行多个编辑操作
   - 多次撤回
   - 多次重做
   - 验证每步都正确恢复

### 性能测试
1. **大文档编辑**
   - 加载包含大量内容的FAQ
   - 执行撤回操作
   - 验证无明显卡顿

2. **快速操作**
   - 快速连续输入和撤回
   - 验证响应流畅

### 边界情况
1. **空内容撤回**
   - 在空编辑器中尝试撤回
   - 验证不会出错

2. **切换FAQ**
   - 编辑一个FAQ
   - 切换到另一个FAQ
   - 验证撤回历史正确重置

## 用户体验改进

1. **更流畅的撤回**：不再有DOM重建导致的闪烁
2. **光标位置保持**：撤回后光标自动定位到正确位置
3. **更快的响应**：原生撤回性能优于自定义实现
4. **标准化行为**：与其他编辑器的撤回行为一致

## 兼容性说明

- 保留了自定义`UndoRedoManager`作为降级方案
- 当浏览器原生撤回失败时自动切换到自定义实现
- 确保在各种浏览器环境下都能正常工作

## 注意事项

1. **撤回按钮状态**：由于无法可靠检测浏览器撤回栈，撤回/重做按钮始终启用
2. **格式化操作**：所有格式化操作现在都通过`insertHTML`实现，确保可撤回
3. **自动保存**：撤回操作后内容仍会触发自动保存

## 后续优化建议

1. **探索Selection API**：进一步优化光标定位
2. **添加撤回步数显示**：显示可撤回的操作数量
3. **实现撤回预览**：鼠标悬停时预览撤回后的内容
4. **性能监控**：添加性能指标追踪撤回操作耗时